<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: BeautifulMigration.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: BeautifulMigration.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/*
 * BeautifulMigration.js
 *
 * https://github.com/monjudoh/BeautifulMigration.js
 * version: 0.0.1
 *
 * Copyright (c) 2013 monjudoh
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 */
/**
 * @module BeautifulMigration
 * @version 0.0.1
 * @author monjudoh
 * @copyright (c) 2013 monjudoh&lt;br/>
 * Dual licensed under the MIT (MIT-LICENSE.txt)&lt;br/>
 * and GPL (GPL-LICENSE.txt) licenses.
 * @see https://github.com/monjudoh/BeautifulMigration.js
 * @see BeautifulMigration
 */
define('BeautifulMigration',
['underscore','jquery'],
function (_,$) {
  /**
   * @name BeautifulMigration
   * @param {string} key
   * @constructor
   *
   * @property {string} key
   */
  function BeautifulMigration(key) {
    this.key = key;
  }

  var versionUpOperations = Object.create(null);
  var storageKeyRetriever = function defaultStorageKeyRetriever(key){
    return ['BeautifulMigration',key].join('.');
  };
  /**
   * @callback BeautifulMigration~versionUpOperation
   * @returns {promise=}
   * @description バージョンアップ処理。&lt;br/>
   * 同期処理の場合は何も返さない。非同期処理の場合はpromiseを返し、非同期処理の完了時にresolveする。
   */
  /**
   * @name registerVersionUpOperation
   * @memberOf BeautifulMigration
   * @function
   *
   * @param {string} key
   * @param {number} version
   * @param {BeautifulMigration~versionUpOperation} operation
   * @description 指定されたkey,versionにおけるバージョンアップの際に呼ばれる処理を登録する。
   */
  BeautifulMigration.registerVersionUpOperation = function registerVersionUpOperation(key,version,operation){
    if (!versionUpOperations[key]) {
      versionUpOperations[key] = [];
    }
    versionUpOperations[key][version] = operation;
  };
  /**
   * @callback BeautifulMigration~storageKeyRetriever
   * @param {string} key
   * @returns {string} storageKey
   * @description 現在のバージョンをlocalStorageに記録する際に使用するkeyを取得するための関数
   */
  /**
   * @name registerStorageKeyRetriever
   * @memberOf BeautifulMigration
   * @function
   *
   * @param {BeautifulMigration~storageKeyRetriever} retriever
   */
  BeautifulMigration.registerStorageKeyRetriever = function registerStorageKeyRetriever(retriever){
    storageKeyRetriever = retriever;
  };
  function versionUp(key,previousVersion,currentVersion) {
    var storageKey = storageKeyRetriever(key);
    var operations = _.compact(versionUpOperations[key].slice(previousVersion+1,currentVersion+1));
    function updateLocalStorage(){
      localStorage[storageKey] = JSON.stringify(currentVersion);
    }
    operations.push(updateLocalStorage);
    operations.unshift($.Deferred().resolve().promise());
    var promise = operations.reduce(function(promise,operation){
      var index = versionUpOperations[key].indexOf(operation);
      return promise.then(function done(){
        if (operation !== updateLocalStorage) {
          console.info('versionUp(key,version)', key, index);
        } else {
          console.info('versionUp(key,previousVersion,currentVersion)', key, previousVersion,currentVersion);
        }
      }).then(operation);
    });
    return promise;
  }
  var proto = BeautifulMigration.prototype;
  /**
   * @name migrate
   * @memberOf BeautifulMigration#
   * @function
   *
   * @param {number} currentVersion 現在のバージョン
   * @returns {promise}
   * @description 現在のバージョンを指定してマイグレーションを行う。&lt;br/>
   * localStorageに記録された前回起動時のバージョンと指定された現在のバージョンを比較してマイグレーションを行う。&lt;br/>
   * マイグレーションの処理が完了すると戻り値のpromiseのdone callbackが呼ばれる。&lt;br/>
   * - 初回起動時&lt;br/>
   * -- TODO実装&lt;br/>
   * - 同一バージョン時&lt;br/>
   * -- 何もしない&lt;br/>
   * - バージョンアップ時&lt;br/>
   * -- 前回起動時のバージョン+1〜指定された現在のバージョンについてのバージョンアップ処理が呼ばれる。&lt;br/>
   * - バージョンダウン時&lt;br/>
   * -- TODO実装
   * @see BeautifulMigration#key
   * @see BeautifulMigration.registerVersionUpOperation
   * @see BeautifulMigration~versionUpOperation
   */
  proto.migrate = function migrate(currentVersion){
    var dfd = $.Deferred();
    // storageKey
    var storageKey = storageKeyRetriever(this.key);
    var previousVersion = JSON.parse(localStorage[storageKey] || 'null');
    console.log(previousVersion,currentVersion);
    if (previousVersion === null) {
      // 初回起動時処理
      console.info('初回起動時処理');
      localStorage[storageKey] = JSON.stringify(currentVersion);
      dfd.resolve();
    } else if (currentVersion === previousVersion) {
      // 同一バージョンなので何もしない
      console.info('同一バージョンなので何もしない');
      dfd.resolve();
    } else if (currentVersion > previousVersion) {
      // バージョンアップ処理
      console.info('バージョンアップ処理');
      return versionUp(this.key,previousVersion,currentVersion);
    } else if (currentVersion &lt; previousVersion) {
      // バージョンダウン処理
      console.info('バージョンダウン処理');
      dfd.resolve();
    } else {
      // localStorageのデータが何かおかしい
      console.info('localStorageのデータが何かおかしい');
    }
    return dfd.promise();
  };

  return BeautifulMigration;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-BeautifulMigration.html">BeautifulMigration</a></li></ul><h3>Classes</h3><ul><li><a href="BeautifulMigration.html">BeautifulMigration</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Tue Sep 24 2013 15:13:47 GMT+0900 (JST)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
